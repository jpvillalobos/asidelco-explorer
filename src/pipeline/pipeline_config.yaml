version: 1

pipeline:
  name: asidelco-explorer
  description: End-to-end ingestion, crawling, transformation, enhancement, and loading
  workspace_root: workspaces

  stages:
    - id: ingest
      title: Ingest
      steps:
        - name: normalize_csv
          title: Select Excel Input File
          args:
            input_file: data/input/Ene-Mar25.xlsx
            output_file: normalized.csv

    - id: crawl
      title: Crawl
      steps:
        - name: crawl_projects
          title: Crawl Projects
          args:
            input_file: data/output/normalized.csv
            base_url: https://servicios.cfia.or.cr
            project_url: https://servicios.cfia.or.cr/ConsultaProyecto/
            output_dir: data/output/projects/html
            rate_limit: 0.5
            max_retries: 3
            timeout: 30

        - name: crawl_professionals
          title: Crawl Professionals
          args:
            input_dir: data/output/projects/html
            base_url: https://servicios.cfia.or.cr
            directory_url: https://servicios.cfia.or.cr/ListadoMiembros/Miembros/
            max_members: 100
            output_dir: data/output/professionals
            rate_limit: 0.5
            max_retries: 3
            timeout: 30

    - id: transform
      title: Transform
      steps:
        - name: parse_html
          title: Convert Project HTML to JSON
          args:
            input_dir: ${workspace}/data/output/projects_html
            output_dir: ${workspace}/data/output/projects_json
            save_json: true

        - name: parse_html
          title: Convert Professional HTML to JSON
          args:
            input_dir: ${workspace}/data/output/professionals_html
            output_dir: ${workspace}/data/output/professionals_json
            save_json: true

        - name: transform_data
          title: Merge CSV + Project JSON + Professional JSON
          args:
            input_file: ${workspace}/data/output/Ene-Mar25_normalized.csv
            output_file: ${workspace}/data/output/merged.json
            transformations:
              - merge:
                  projects_json_dir: ${workspace}/data/output/projects_json
                  professionals_json_dir: ${workspace}/data/output/professionals_json

    - id: enhance
      title: Enhance
      steps:
        - name: generate_embeddings
          title: Add Embeddings
          args:
            input_file: ${workspace}/data/output/merged.json
            text_column: content
            model: sbert
            output_file: ${workspace}/data/output/merged_emb.json

        - name: transform_data
          title: Add Geocodes (Lat/Lon)
          args:
            input_file: ${workspace}/data/output/merged_emb.json
            output_file: ${workspace}/data/output/merged_enriched.json
            transformations:
              - add_geocoding: true

    - id: load
      title: Load
      steps:
        - name: load_opensearch
          title: Load to OpenSearch
          args:
            input_file: ${workspace}/data/output/merged_enriched.json
            host: localhost
            port: 9200
            index_name: asidelco-explorer