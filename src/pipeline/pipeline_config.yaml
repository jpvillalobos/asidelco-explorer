version: 1

pipeline:
  name: asidelco-explorer
  description: End-to-end ingestion, crawling, transformation, enhancement, and loading
  workspace_root: workspaces

  stages:
    - id: ingest
      title: Ingest
      description: Load and normalize input CSV/Excel file
      steps:
        - name: normalize_csv
          title: Normalize Input File
          args:
            input_file: data/input/Ene-Mar25.xlsx
            output_file: data/output/normalized.csv

    - id: crawl
      title: Crawl
      description: Crawl CFIA website for project and professional data
      steps:
        - name: crawl_projects
          title: Crawl Projects
          args:
            input_file: data/output/normalized.csv
            base_url: https://servicios.cfia.or.cr
            project_url: https://servicios.cfia.or.cr/ConsultaProyecto/
            output_dir: data/output/projects/html
            rate_limit: 0.5
            max_retries: 3
            timeout: 30

        - name: crawl_professionals
          title: Crawl Professionals
          args:
            input_dir: data/output/projects/html
            base_url: https://servicios.cfia.or.cr
            directory_url: https://servicios.cfia.or.cr/ListadoMiembros/Miembros/
            max_members: 100
            output_dir: data/output/professionals
            rate_limit: 0.5
            max_retries: 3
            timeout: 30

    - id: transform
      title: Transform
      description: Parse HTML to JSON and merge data sources
      steps:
        - name: parse_html
          title: Parse Project HTML to JSON
          args:
            input_dir: data/output/projects/html
            output_dir: data/output/projects/json
            save_json: true

        - name: parse_html
          title: Parse Professional HTML to JSON
          args:
            input_dir: data/output/professionals/html
            output_dir: data/output/professionals/json
            save_json: true

        - name: merge_data
          title: Merge CSV + Projects + Professionals
          args:
            csv_file: data/output/normalized.csv
            projects_json_dir: data/output/projects/json
            professionals_json_dir: data/output/professionals/json
            output_file: data/output/merged.json

        - name: flatten_normalize
          title: Flatten and Normalize Data
          args:
            input_file: data/output/merged.json
            output_file: data/output/flattened.json
            normalize_text: true
            normalize_dates: true

    - id: enhance
      title: Enhance
      description: Validate, enrich, and add embeddings
      steps:
        - name: validate_enrich
          title: Validate and Enrich Data
          args:
            input_file: data/output/flattened.json
            output_file: data/output/enriched.json
            validation_rules: null

        - name: generate_embeddings
          title: Generate Text Embeddings
          args:
            input_file: data/output/enriched.json
            text_field: project_data.Descripci√≥n del proyecto
            model: openai
            output_file: data/output/enriched_with_embeddings.json

    - id: load
      title: Load
      description: Load data to OpenSearch and Neo4j
      steps:
        - name: load_opensearch
          title: Load to OpenSearch
          args:
            input_file: data/output/enriched_with_embeddings.json
            host: localhost
            port: 9200
            index_name: asidelco-explorer

        - name: load_neo4j
          title: Load to Neo4j
          args:
            input_file: data/output/enriched_with_embeddings.json
            uri: bolt://localhost:7687
            auth: null